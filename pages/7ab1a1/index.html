<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>菜单和权限管理 | DC&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="/fonts/iconfont.css">
    <meta name="description" content="人类终将毁灭,世界属于三体!">
    <meta name="keywords" content="DC的个人博客.">
    
    <link rel="preload" href="/assets/css/0.styles.66b92039.css" as="style"><link rel="preload" href="/assets/js/app.ac54adc6.js" as="script"><link rel="preload" href="/assets/js/4.7ddc74e3.js" as="script"><link rel="preload" href="/assets/js/1.a0c4ff1b.js" as="script"><link rel="preload" href="/assets/js/3.8b03321d.js" as="script"><link rel="preload" href="/assets/js/18.46f9153d.js" as="script"><link rel="preload" href="/assets/js/104.cae2d944.js" as="script"><link rel="preload" href="/assets/js/184.46eabf07.js" as="script"><link rel="prefetch" href="/assets/js/10.a91ae011.js"><link rel="prefetch" href="/assets/js/100.2e8ea472.js"><link rel="prefetch" href="/assets/js/101.46f57a02.js"><link rel="prefetch" href="/assets/js/102.f51bcd80.js"><link rel="prefetch" href="/assets/js/103.3f003e0e.js"><link rel="prefetch" href="/assets/js/105.6c6ebc28.js"><link rel="prefetch" href="/assets/js/106.47dc8889.js"><link rel="prefetch" href="/assets/js/107.6b5602b4.js"><link rel="prefetch" href="/assets/js/108.46f0c21d.js"><link rel="prefetch" href="/assets/js/109.0f1168a5.js"><link rel="prefetch" href="/assets/js/11.e6a94228.js"><link rel="prefetch" href="/assets/js/110.6a961498.js"><link rel="prefetch" href="/assets/js/111.c6f27c88.js"><link rel="prefetch" href="/assets/js/112.9ee3d3bb.js"><link rel="prefetch" href="/assets/js/113.82b72aa0.js"><link rel="prefetch" href="/assets/js/114.7487460e.js"><link rel="prefetch" href="/assets/js/115.cd079d0a.js"><link rel="prefetch" href="/assets/js/116.b6b829eb.js"><link rel="prefetch" href="/assets/js/117.89d9336c.js"><link rel="prefetch" href="/assets/js/118.467c4437.js"><link rel="prefetch" href="/assets/js/119.c4b2ac40.js"><link rel="prefetch" href="/assets/js/12.9d3501e4.js"><link rel="prefetch" href="/assets/js/120.5ff31c09.js"><link rel="prefetch" href="/assets/js/121.2e59c3a5.js"><link rel="prefetch" href="/assets/js/122.a66096cf.js"><link rel="prefetch" href="/assets/js/123.4885ba5f.js"><link rel="prefetch" href="/assets/js/124.cacc66be.js"><link rel="prefetch" href="/assets/js/125.dc5b30fe.js"><link rel="prefetch" href="/assets/js/126.4e21eb5e.js"><link rel="prefetch" href="/assets/js/127.cb36a9bf.js"><link rel="prefetch" href="/assets/js/128.ce38358e.js"><link rel="prefetch" href="/assets/js/129.e5f414eb.js"><link rel="prefetch" href="/assets/js/13.ca017a68.js"><link rel="prefetch" href="/assets/js/130.17b597f0.js"><link rel="prefetch" href="/assets/js/131.e1ded2dc.js"><link rel="prefetch" href="/assets/js/132.aae1c627.js"><link rel="prefetch" href="/assets/js/133.73cecdb3.js"><link rel="prefetch" href="/assets/js/134.80cf38a0.js"><link rel="prefetch" href="/assets/js/135.735ed588.js"><link rel="prefetch" href="/assets/js/136.91f8db08.js"><link rel="prefetch" href="/assets/js/137.d6fb8bda.js"><link rel="prefetch" href="/assets/js/138.75cafe73.js"><link rel="prefetch" href="/assets/js/139.b01bf0db.js"><link rel="prefetch" href="/assets/js/14.ee2605b5.js"><link rel="prefetch" href="/assets/js/140.ff0a7911.js"><link rel="prefetch" href="/assets/js/141.c69e7f54.js"><link rel="prefetch" href="/assets/js/142.997b03ac.js"><link rel="prefetch" href="/assets/js/143.e40faea8.js"><link rel="prefetch" href="/assets/js/144.369f23e5.js"><link rel="prefetch" href="/assets/js/145.1268424d.js"><link rel="prefetch" href="/assets/js/146.94c65c4a.js"><link rel="prefetch" href="/assets/js/147.05fe6a36.js"><link rel="prefetch" href="/assets/js/148.327cc29d.js"><link rel="prefetch" href="/assets/js/149.90068676.js"><link rel="prefetch" href="/assets/js/15.42e0a0e4.js"><link rel="prefetch" href="/assets/js/150.b4b780bb.js"><link rel="prefetch" href="/assets/js/151.b4611012.js"><link rel="prefetch" href="/assets/js/152.4d2c8246.js"><link rel="prefetch" href="/assets/js/153.f32dfa58.js"><link rel="prefetch" href="/assets/js/154.b79a78fb.js"><link rel="prefetch" href="/assets/js/155.6ad2865c.js"><link rel="prefetch" href="/assets/js/156.fd49a1af.js"><link rel="prefetch" href="/assets/js/157.55113800.js"><link rel="prefetch" href="/assets/js/158.af321bc9.js"><link rel="prefetch" href="/assets/js/159.37d9c659.js"><link rel="prefetch" href="/assets/js/16.007f45b3.js"><link rel="prefetch" href="/assets/js/160.7a3b5a9a.js"><link rel="prefetch" href="/assets/js/161.fc1fbea8.js"><link rel="prefetch" href="/assets/js/162.2f8d3d1c.js"><link rel="prefetch" href="/assets/js/163.aa889940.js"><link rel="prefetch" href="/assets/js/164.5d8b2cb7.js"><link rel="prefetch" href="/assets/js/165.44d4a9b5.js"><link rel="prefetch" href="/assets/js/166.c1b4c4d4.js"><link rel="prefetch" href="/assets/js/167.0c39929e.js"><link rel="prefetch" href="/assets/js/168.fede035a.js"><link rel="prefetch" href="/assets/js/169.ff940d50.js"><link rel="prefetch" href="/assets/js/17.7395c644.js"><link rel="prefetch" href="/assets/js/170.b6fcb3bf.js"><link rel="prefetch" href="/assets/js/171.2b927a7c.js"><link rel="prefetch" href="/assets/js/172.b07a90a1.js"><link rel="prefetch" href="/assets/js/173.367352bf.js"><link rel="prefetch" href="/assets/js/174.4ea4e20f.js"><link rel="prefetch" href="/assets/js/175.d9679b61.js"><link rel="prefetch" href="/assets/js/176.f7804143.js"><link rel="prefetch" href="/assets/js/177.c5d1e680.js"><link rel="prefetch" href="/assets/js/178.808293fa.js"><link rel="prefetch" href="/assets/js/179.2acf6b3c.js"><link rel="prefetch" href="/assets/js/180.ddf3ecf7.js"><link rel="prefetch" href="/assets/js/181.4da0855c.js"><link rel="prefetch" href="/assets/js/182.591d135a.js"><link rel="prefetch" href="/assets/js/183.9d08f9fe.js"><link rel="prefetch" href="/assets/js/185.ee1c8428.js"><link rel="prefetch" href="/assets/js/186.c7b19133.js"><link rel="prefetch" href="/assets/js/187.52945990.js"><link rel="prefetch" href="/assets/js/188.a1d395c5.js"><link rel="prefetch" href="/assets/js/189.5b66165e.js"><link rel="prefetch" href="/assets/js/19.2db19edb.js"><link rel="prefetch" href="/assets/js/190.265a75de.js"><link rel="prefetch" href="/assets/js/191.b4c65143.js"><link rel="prefetch" href="/assets/js/192.cc4d4115.js"><link rel="prefetch" href="/assets/js/193.fa02ecc5.js"><link rel="prefetch" href="/assets/js/194.b0c9ad53.js"><link rel="prefetch" href="/assets/js/195.eda8cd34.js"><link rel="prefetch" href="/assets/js/196.cbae4dc6.js"><link rel="prefetch" href="/assets/js/197.693b1b85.js"><link rel="prefetch" href="/assets/js/198.8213665b.js"><link rel="prefetch" href="/assets/js/199.ddf0036d.js"><link rel="prefetch" href="/assets/js/2.4c15b693.js"><link rel="prefetch" href="/assets/js/20.6742e8ae.js"><link rel="prefetch" href="/assets/js/200.340df508.js"><link rel="prefetch" href="/assets/js/201.7431c15b.js"><link rel="prefetch" href="/assets/js/202.217b2b38.js"><link rel="prefetch" href="/assets/js/203.06c6a93d.js"><link rel="prefetch" href="/assets/js/204.a068a898.js"><link rel="prefetch" href="/assets/js/205.9361d3f5.js"><link rel="prefetch" href="/assets/js/206.886beca0.js"><link rel="prefetch" href="/assets/js/207.2278bda8.js"><link rel="prefetch" href="/assets/js/208.db0acc0d.js"><link rel="prefetch" href="/assets/js/209.0e05b204.js"><link rel="prefetch" href="/assets/js/21.fd552a4e.js"><link rel="prefetch" href="/assets/js/210.4c730041.js"><link rel="prefetch" href="/assets/js/211.417dbee1.js"><link rel="prefetch" href="/assets/js/212.eef4f4a3.js"><link rel="prefetch" href="/assets/js/213.ab742b0b.js"><link rel="prefetch" href="/assets/js/214.a57228de.js"><link rel="prefetch" href="/assets/js/215.37f52459.js"><link rel="prefetch" href="/assets/js/216.2f110f92.js"><link rel="prefetch" href="/assets/js/217.09654311.js"><link rel="prefetch" href="/assets/js/218.a7568950.js"><link rel="prefetch" href="/assets/js/219.628ee193.js"><link rel="prefetch" href="/assets/js/22.465a76d2.js"><link rel="prefetch" href="/assets/js/220.c5df9186.js"><link rel="prefetch" href="/assets/js/221.101ddb09.js"><link rel="prefetch" href="/assets/js/222.db210e3c.js"><link rel="prefetch" href="/assets/js/223.429cbf14.js"><link rel="prefetch" href="/assets/js/224.aa002868.js"><link rel="prefetch" href="/assets/js/225.79a40017.js"><link rel="prefetch" href="/assets/js/226.3e08228b.js"><link rel="prefetch" href="/assets/js/227.a09dd4b4.js"><link rel="prefetch" href="/assets/js/228.f930c492.js"><link rel="prefetch" href="/assets/js/229.f639a9e4.js"><link rel="prefetch" href="/assets/js/23.df6831af.js"><link rel="prefetch" href="/assets/js/230.e8ac7aad.js"><link rel="prefetch" href="/assets/js/231.99501214.js"><link rel="prefetch" href="/assets/js/232.e2932792.js"><link rel="prefetch" href="/assets/js/233.43dfa689.js"><link rel="prefetch" href="/assets/js/234.7951f9c4.js"><link rel="prefetch" href="/assets/js/235.1dc96b6c.js"><link rel="prefetch" href="/assets/js/236.40b8d4e4.js"><link rel="prefetch" href="/assets/js/237.75a692de.js"><link rel="prefetch" href="/assets/js/238.cc9d9ac1.js"><link rel="prefetch" href="/assets/js/239.4616a566.js"><link rel="prefetch" href="/assets/js/24.b68dc734.js"><link rel="prefetch" href="/assets/js/240.dd825147.js"><link rel="prefetch" href="/assets/js/241.85e3219b.js"><link rel="prefetch" href="/assets/js/242.bf4123c4.js"><link rel="prefetch" href="/assets/js/243.ce68f4f0.js"><link rel="prefetch" href="/assets/js/244.e2598d4d.js"><link rel="prefetch" href="/assets/js/245.2c696827.js"><link rel="prefetch" href="/assets/js/246.2c44a497.js"><link rel="prefetch" href="/assets/js/247.02405fce.js"><link rel="prefetch" href="/assets/js/248.6727bdf6.js"><link rel="prefetch" href="/assets/js/249.4901f575.js"><link rel="prefetch" href="/assets/js/25.d639c65c.js"><link rel="prefetch" href="/assets/js/250.c922c9ea.js"><link rel="prefetch" href="/assets/js/251.b1350ead.js"><link rel="prefetch" href="/assets/js/252.8295c5ea.js"><link rel="prefetch" href="/assets/js/253.b0a9ba20.js"><link rel="prefetch" href="/assets/js/254.d208b848.js"><link rel="prefetch" href="/assets/js/255.2cfb6ad3.js"><link rel="prefetch" href="/assets/js/256.e7687a81.js"><link rel="prefetch" href="/assets/js/257.db329d54.js"><link rel="prefetch" href="/assets/js/258.be75b1f9.js"><link rel="prefetch" href="/assets/js/259.67500f7e.js"><link rel="prefetch" href="/assets/js/26.9db429a9.js"><link rel="prefetch" href="/assets/js/260.73609cfa.js"><link rel="prefetch" href="/assets/js/261.22fc7c08.js"><link rel="prefetch" href="/assets/js/262.2c620ccd.js"><link rel="prefetch" href="/assets/js/263.e0ce1454.js"><link rel="prefetch" href="/assets/js/264.7fe82318.js"><link rel="prefetch" href="/assets/js/265.537d06c5.js"><link rel="prefetch" href="/assets/js/266.901695a7.js"><link rel="prefetch" href="/assets/js/267.8eb24590.js"><link rel="prefetch" href="/assets/js/268.a21e44dc.js"><link rel="prefetch" href="/assets/js/269.33e6ce5d.js"><link rel="prefetch" href="/assets/js/27.2296e284.js"><link rel="prefetch" href="/assets/js/270.31507ac3.js"><link rel="prefetch" href="/assets/js/271.b9406b42.js"><link rel="prefetch" href="/assets/js/272.0acaba6f.js"><link rel="prefetch" href="/assets/js/273.c2e359b0.js"><link rel="prefetch" href="/assets/js/274.a80428a6.js"><link rel="prefetch" href="/assets/js/28.7e4f4dc1.js"><link rel="prefetch" href="/assets/js/29.ba75f79a.js"><link rel="prefetch" href="/assets/js/30.16cd3622.js"><link rel="prefetch" href="/assets/js/31.54ed5bc1.js"><link rel="prefetch" href="/assets/js/32.b2fbba6a.js"><link rel="prefetch" href="/assets/js/33.f7ff0107.js"><link rel="prefetch" href="/assets/js/34.4b2cea7d.js"><link rel="prefetch" href="/assets/js/35.1159e74c.js"><link rel="prefetch" href="/assets/js/36.0b6296f3.js"><link rel="prefetch" href="/assets/js/37.fc67879e.js"><link rel="prefetch" href="/assets/js/38.637afaf8.js"><link rel="prefetch" href="/assets/js/39.748a78f3.js"><link rel="prefetch" href="/assets/js/40.4fede9bb.js"><link rel="prefetch" href="/assets/js/41.c7f0b087.js"><link rel="prefetch" href="/assets/js/42.5b1a487d.js"><link rel="prefetch" href="/assets/js/43.59275b93.js"><link rel="prefetch" href="/assets/js/44.b18a4c94.js"><link rel="prefetch" href="/assets/js/45.bc8f7cb3.js"><link rel="prefetch" href="/assets/js/46.6a4ec89f.js"><link rel="prefetch" href="/assets/js/47.e1e129e6.js"><link rel="prefetch" href="/assets/js/48.c284ce23.js"><link rel="prefetch" href="/assets/js/49.17e5dd65.js"><link rel="prefetch" href="/assets/js/5.e3d12916.js"><link rel="prefetch" href="/assets/js/50.34c3ac45.js"><link rel="prefetch" href="/assets/js/51.035f7031.js"><link rel="prefetch" href="/assets/js/52.e9ef227a.js"><link rel="prefetch" href="/assets/js/53.ecbb032d.js"><link rel="prefetch" href="/assets/js/54.e9af4cfe.js"><link rel="prefetch" href="/assets/js/55.7e71402b.js"><link rel="prefetch" href="/assets/js/56.511071fe.js"><link rel="prefetch" href="/assets/js/57.13b7fe79.js"><link rel="prefetch" href="/assets/js/58.e51f8b0e.js"><link rel="prefetch" href="/assets/js/59.a1b8bdb7.js"><link rel="prefetch" href="/assets/js/6.5fc3f358.js"><link rel="prefetch" href="/assets/js/60.fd7e1c08.js"><link rel="prefetch" href="/assets/js/61.0daf2361.js"><link rel="prefetch" href="/assets/js/62.04632944.js"><link rel="prefetch" href="/assets/js/63.f0dd5615.js"><link rel="prefetch" href="/assets/js/64.89a4b562.js"><link rel="prefetch" href="/assets/js/65.6764ff0c.js"><link rel="prefetch" href="/assets/js/66.049bdee1.js"><link rel="prefetch" href="/assets/js/67.b0d4ec16.js"><link rel="prefetch" href="/assets/js/68.46d97067.js"><link rel="prefetch" href="/assets/js/69.f540f0da.js"><link rel="prefetch" href="/assets/js/7.ce17dd73.js"><link rel="prefetch" href="/assets/js/70.17d8f857.js"><link rel="prefetch" href="/assets/js/71.b2a166a0.js"><link rel="prefetch" href="/assets/js/72.1c17a875.js"><link rel="prefetch" href="/assets/js/73.dac8984b.js"><link rel="prefetch" href="/assets/js/74.5bbc33ac.js"><link rel="prefetch" href="/assets/js/75.483644c7.js"><link rel="prefetch" href="/assets/js/76.de5461ab.js"><link rel="prefetch" href="/assets/js/77.7fa90702.js"><link rel="prefetch" href="/assets/js/78.f41853b8.js"><link rel="prefetch" href="/assets/js/79.598b50e6.js"><link rel="prefetch" href="/assets/js/80.61d2d23a.js"><link rel="prefetch" href="/assets/js/81.d310c6e4.js"><link rel="prefetch" href="/assets/js/82.22aa814c.js"><link rel="prefetch" href="/assets/js/83.f493eba4.js"><link rel="prefetch" href="/assets/js/84.3a32a1eb.js"><link rel="prefetch" href="/assets/js/85.2f47134e.js"><link rel="prefetch" href="/assets/js/86.74e65a77.js"><link rel="prefetch" href="/assets/js/87.e87bff96.js"><link rel="prefetch" href="/assets/js/88.aabc97af.js"><link rel="prefetch" href="/assets/js/89.b0945d87.js"><link rel="prefetch" href="/assets/js/90.630f62d3.js"><link rel="prefetch" href="/assets/js/91.ed816647.js"><link rel="prefetch" href="/assets/js/92.19065457.js"><link rel="prefetch" href="/assets/js/93.a0fe1919.js"><link rel="prefetch" href="/assets/js/94.51e48580.js"><link rel="prefetch" href="/assets/js/95.e591bede.js"><link rel="prefetch" href="/assets/js/96.1723f1d6.js"><link rel="prefetch" href="/assets/js/97.02bbb7d4.js"><link rel="prefetch" href="/assets/js/98.a3625ba6.js"><link rel="prefetch" href="/assets/js/99.1accbf48.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.5959bfd2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.66b92039.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/nav-logo.png" alt="DC's blog" class="logo"> <span class="site-name can-hide">DC's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="IT必备" class="dropdown-title"><a href="/IT/" class="link-title">IT必备</a> <span class="title" style="display:none;">IT必备</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/IT/basis/" class="nav-link">计算机基础</a></li><li class="dropdown-item"><!----> <a href="/IT/linux/" class="nav-link">linux基础</a></li><li class="dropdown-item"><!----> <a href="/IT/mysql/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/IT/git/" class="nav-link">git</a></li><li class="dropdown-item"><!----> <a href="/IT/structure/" class="nav-link">数据结构与算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><a href="/python/" class="link-title">Python</a> <span class="title" style="display:none;">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python/basis/" class="nav-link">opp</a></li><li class="dropdown-item"><!----> <a href="/python/oop/" class="nav-link">oop</a></li><li class="dropdown-item"><!----> <a href="/python/Network_concurrency/" class="nav-link">网络并发编程</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/front_end/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front_end/html/" class="nav-link">html</a></li><li class="dropdown-item"><!----> <a href="/front_end/css/" class="nav-link">css</a></li><li class="dropdown-item"><!----> <a href="/front_end/js/" class="nav-link">javascript</a></li><li class="dropdown-item"><!----> <a href="/front_end/jquery/" class="nav-link">jquery</a></li><li class="dropdown-item"><!----> <a href="/front_end/ui/" class="nav-link">UI</a></li><li class="dropdown-item"><!----> <a href="/front_end/vue/" class="nav-link">vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><a href="/python_web/" class="link-title">后端</a> <span class="title" style="display:none;">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python_web/django/" class="nav-link">Django</a></li><li class="dropdown-item"><!----> <a href="/python_web/drf/" class="nav-link">drf</a></li><li class="dropdown-item"><!----> <a href="/python_web/drf_re/" class="nav-link">drf_re</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实战" class="dropdown-title"><a href="/project/" class="link-title">实战</a> <span class="title" style="display:none;">实战</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前后端不分离</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/project/bbs/" class="nav-link">BBS</a></li><li class="dropdown-subitem"><a href="/project/order/" class="nav-link">订单系统</a></li><li class="dropdown-subitem"><a href="/project/crm/" class="nav-link">CRM</a></li></ul></li><li class="dropdown-item"><h4>前后端分离</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/project/supply/" class="nav-link">供应链系统</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><a href="/other/" class="link-title">其他</a> <span class="title" style="display:none;">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/essays/" class="nav-link">杂文</a></li><li class="dropdown-item"><h4>关于我</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/about/" class="nav-link">me</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><!----> <span class="title" style="display:;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/OnePieceDC/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.gif"> <div class="blogger-info"><h3>DC</h3> <span>愿我一生欢喜,不为世俗所及.</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="IT必备" class="dropdown-title"><a href="/IT/" class="link-title">IT必备</a> <span class="title" style="display:none;">IT必备</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/IT/basis/" class="nav-link">计算机基础</a></li><li class="dropdown-item"><!----> <a href="/IT/linux/" class="nav-link">linux基础</a></li><li class="dropdown-item"><!----> <a href="/IT/mysql/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/IT/git/" class="nav-link">git</a></li><li class="dropdown-item"><!----> <a href="/IT/structure/" class="nav-link">数据结构与算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><a href="/python/" class="link-title">Python</a> <span class="title" style="display:none;">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python/basis/" class="nav-link">opp</a></li><li class="dropdown-item"><!----> <a href="/python/oop/" class="nav-link">oop</a></li><li class="dropdown-item"><!----> <a href="/python/Network_concurrency/" class="nav-link">网络并发编程</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/front_end/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front_end/html/" class="nav-link">html</a></li><li class="dropdown-item"><!----> <a href="/front_end/css/" class="nav-link">css</a></li><li class="dropdown-item"><!----> <a href="/front_end/js/" class="nav-link">javascript</a></li><li class="dropdown-item"><!----> <a href="/front_end/jquery/" class="nav-link">jquery</a></li><li class="dropdown-item"><!----> <a href="/front_end/ui/" class="nav-link">UI</a></li><li class="dropdown-item"><!----> <a href="/front_end/vue/" class="nav-link">vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><a href="/python_web/" class="link-title">后端</a> <span class="title" style="display:none;">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python_web/django/" class="nav-link">Django</a></li><li class="dropdown-item"><!----> <a href="/python_web/drf/" class="nav-link">drf</a></li><li class="dropdown-item"><!----> <a href="/python_web/drf_re/" class="nav-link">drf_re</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实战" class="dropdown-title"><a href="/project/" class="link-title">实战</a> <span class="title" style="display:none;">实战</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前后端不分离</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/project/bbs/" class="nav-link">BBS</a></li><li class="dropdown-subitem"><a href="/project/order/" class="nav-link">订单系统</a></li><li class="dropdown-subitem"><a href="/project/crm/" class="nav-link">CRM</a></li></ul></li><li class="dropdown-item"><h4>前后端分离</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/project/supply/" class="nav-link">供应链系统</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><a href="/other/" class="link-title">其他</a> <span class="title" style="display:none;">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/essays/" class="nav-link">杂文</a></li><li class="dropdown-item"><h4>关于我</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/about/" class="nav-link">me</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><!----> <span class="title" style="display:;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/OnePieceDC/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>BBS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>订单平台</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>CRM</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>rbac</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/1fb3a1/" class="sidebar-link">动态菜单</a></li><li><a href="/pages/7ab1a1/" aria-current="page" class="active sidebar-link">菜单和权限管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/7ab1a1/#角色管理" class="sidebar-link">角色管理</a></li><li class="sidebar-sub-header level2"><a href="/pages/7ab1a1/#用户管理" class="sidebar-link">用户管理</a></li><li class="sidebar-sub-header level2"><a href="/pages/7ab1a1/#菜单和权限管理" class="sidebar-link">菜单和权限管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/7ab1a1/#三级联动" class="sidebar-link">三级联动</a></li><li class="sidebar-sub-header level3"><a href="/pages/7ab1a1/#保留url原搜索条件" class="sidebar-link">保留URL原搜索条件</a></li><li class="sidebar-sub-header level3"><a href="/pages/7ab1a1/#modelfrom定制radio" class="sidebar-link">ModelFrom定制radio</a></li><li class="sidebar-sub-header level3"><a href="/pages/7ab1a1/#modelfrom显示默认值" class="sidebar-link">ModelFrom显示默认值</a></li><li class="sidebar-sub-header level3"><a href="/pages/7ab1a1/#save前修改instance" class="sidebar-link">save前修改instance</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/7ab1a1/#formset的使用" class="sidebar-link">formset的使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/7ab1a1/#formset的批量添加" class="sidebar-link">formset的批量添加</a></li><li class="sidebar-sub-header level3"><a href="/pages/7ab1a1/#formset的批量更新" class="sidebar-link">formset的批量更新</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/7ab1a1/#自动发现项目中url" class="sidebar-link">自动发现项目中URL</a></li><li class="sidebar-sub-header level2"><a href="/pages/7ab1a1/#权限的批量操作" class="sidebar-link">权限的批量操作</a></li></ul></li><li><a href="/pages/7an1m1/" class="sidebar-link">权限分配</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>stark</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>供应链</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-91157402><div class="articleInfo" data-v-91157402><ul class="breadcrumbs" data-v-91157402><li data-v-91157402><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-91157402></a></li> <li data-v-91157402><a href="/categories/?category=%E5%AE%9E%E6%88%98" title="分类" data-v-91157402>实战</a></li><li data-v-91157402><a href="/categories/?category=CRM" title="分类" data-v-91157402>CRM</a></li><li data-v-91157402><a href="/categories/?category=rbac" title="分类" data-v-91157402>rbac</a></li></ul> <div class="info" data-v-91157402><div title="作者" class="author iconfont icon-touxiang" data-v-91157402><a href="https://github.com/OnePieceDC" target="_blank" title="作者" class="beLink" data-v-91157402>DC</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-91157402><a href="javascript:;" data-v-91157402>2024-03-01</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">菜单和权限管理<!----></h1> <!----> <div class="theme-vdoing-content content__default"><p>在前面一章节博客中, 我们进行了基本的权限控制和动态菜单的实现.<br>
细心的你应该可以发现, 完成这些功能的前提是 进行权限、用户、角色信息的录入!<br>
当时我们是基于Django admin后台进行的信息录入. 这种方式不太友好. 接下来, 我们换一种方式完成权限分配相关的操作.</p> <p><font color="blue">注: 为了方便进行编码,先在layout.html中注释掉 动态菜单和面包屑 的代码 + 注释掉 中间件的代码!!</font></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">-</span> 角色管理
<span class="token operator">-</span> 用户管理
<span class="token operator">-</span> 菜单和权限管理
<span class="token operator">-</span> 批量的权限操作
<span class="token operator">-</span> 分配权限 <span class="token operator">==</span><span class="token operator">&gt;</span> 专门用来处理 角色<span class="token punctuation">:</span>用户<span class="token punctuation">:</span>权限三者之间关系的<span class="token punctuation">,</span><span class="token operator">&lt;</span>外键<span class="token operator">&gt;</span>  <span class="token string">&quot;因为篇幅原因,分配权限单独弄了一个md来写&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><hr> <h2 id="角色管理"><a href="#角色管理" class="header-anchor">#</a> 角色管理</h2> <blockquote><p>此处对Role表的title字段进行处理, permissions外键字段在 后续的分配权限处 进行处理!!</p></blockquote> <p><font color="brown">应用场景: 就是纯粹的对一张单表CURD, 不涉及到外键、自定义字段啥的! So, 添加和删除都使用的是同一个Form表单!</font><br>
(*≧ω≦) CURD都大同小异, 后续复杂的场景都是基于下面这个模版根据需求作的一些改变!! 慢慢悟,对比比较,很快就会明白的.</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render<span class="token punctuation">,</span> redirect
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> reverse

<span class="token keyword">from</span> apps<span class="token punctuation">.</span>rbac <span class="token keyword">import</span> models
<span class="token keyword">from</span> <span class="token punctuation">.</span>form <span class="token keyword">import</span> RoleModelForm


<span class="token keyword">def</span> <span class="token function">role_list</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;角色列表&quot;&quot;&quot;</span>
    role_queryset <span class="token operator">=</span> models<span class="token punctuation">.</span>Role<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'rbac/role/role_list.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'roles'</span><span class="token punctuation">:</span> role_queryset<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">role_add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;添加角色&quot;&quot;&quot;</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        form <span class="token operator">=</span> RoleModelForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'rbac/change.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">}</span><span class="token punctuation">)</span>

    form <span class="token operator">=</span> RoleModelForm<span class="token punctuation">(</span>data<span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
    <span class="token keyword">if</span> form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        form<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'rbac:role_list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'rbac/change.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">role_edit</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> pk<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;编辑角色&quot;&quot;&quot;</span>
    obj <span class="token operator">=</span> models<span class="token punctuation">.</span>Role<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>pk<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> obj<span class="token punctuation">:</span>  <span class="token comment"># -- 保证不会人为的修改页面url中的id值!!</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'rbac/500.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f&quot;ID值为</span><span class="token interpolation"><span class="token punctuation">{</span>pk<span class="token punctuation">}</span></span><span class="token string">的角色不存在,请联系管理员!&quot;</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        form <span class="token operator">=</span> RoleModelForm<span class="token punctuation">(</span>instance<span class="token operator">=</span>obj<span class="token punctuation">)</span>  <span class="token comment"># -- 修改时显示初始数据!!</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'rbac/change.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">}</span><span class="token punctuation">)</span>
    form <span class="token operator">=</span> RoleModelForm<span class="token punctuation">(</span>data<span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">,</span> instance<span class="token operator">=</span>obj<span class="token punctuation">)</span>  <span class="token comment"># -- 前者用于校验,后者是确定修改哪条记录</span>
    <span class="token keyword">if</span> form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        form<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>reverse<span class="token punctuation">(</span><span class="token string">'rbac:role_list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'rbac/change.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">role_del</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> pk<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;删除角色&quot;&quot;&quot;</span>
    role_queryset <span class="token operator">=</span> models<span class="token punctuation">.</span>Role<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>pk<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> role_queryset<span class="token punctuation">:</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'rbac/500.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;该角色不存在,请联系管理员!&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    origin_url <span class="token operator">=</span> reverse<span class="token punctuation">(</span><span class="token string">'rbac:role_list'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'rbac/delete.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'cancel'</span><span class="token punctuation">:</span> origin_url<span class="token punctuation">}</span><span class="token punctuation">)</span>

    role_queryset<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>origin_url<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p><strong>效果动态如下:</strong></p> <p><img src="/assets/img/37.ffcff0dd.gif" alt="37"></p> <p>具体的代码就不展示啦!就是普遍的Django CURD. 注意几个点:</p> <p>■ 根据namcespace和name反向生成URL</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">-</span> 根路由
   path<span class="token punctuation">(</span><span class="token string">'rbac/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'apps.rbac.urls'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">&quot;rbac&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token operator">-</span> app_rbac
   path<span class="token punctuation">(</span><span class="token string">'role/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'apps.rbac.views.role.routers'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token operator">-</span> role的routers
   urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
       path<span class="token punctuation">(</span><span class="token string">'list/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>role_list<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'role_list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       path<span class="token punctuation">(</span><span class="token string">'add/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>role_add<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'role_add'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       path<span class="token punctuation">(</span><span class="token string">'edit/&lt;int:pk&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>role_edit<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'role_edit'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       path<span class="token punctuation">(</span><span class="token string">'del/&lt;int:pk&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>role_del<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'role_del'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token punctuation">]</span>
<span class="token operator">-</span> 模版中 举个栗子
<span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;{% url 'rbac:role_edit' row.pk %}&quot;</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>■ 添加和编辑模版代码的复用</p> <p><img src="/assets/img/image-20240310161525443.c2b9e138.png" alt="image-20240310161525443"></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>细心的观察 添加和编辑的视图代码 返回给前端模版的数据 都是form对象!! <span class="token string">&quot;在模版中通过for循环进行渲染即可!!&quot;</span>
★ form对象中包含多少个字段对象<span class="token punctuation">,</span>都是在各自的modelform中处理好了的<span class="token punctuation">.</span>
So<span class="token punctuation">,</span>添加和编辑的模版代码是一样的<span class="token punctuation">,</span>我们命名为 change<span class="token punctuation">.</span>html <span class="token operator">&lt;</span>在其他地方也可以进行复用<span class="token operator">&gt;</span>

PS<span class="token punctuation">:</span> html中的label对应ORM表中字段的verbose_name的属性值
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>■ 删除模版代码的复用</p> <p><img src="/assets/img/image-20240310161043422.f2a849f9.png" alt="image-20240310161043422"></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>删除的模版代码也可进行复用 特别注意的是<span class="token punctuation">:</span>
<span class="token number">1</span><span class="token operator">&gt;</span> <span class="token string">&quot;传入模版中的cancel值&quot;</span> 表明点击取消按钮后 返回<span class="token string">&quot;哪里&quot;</span>的列表页面! 示例中是返角色列表!!
<span class="token number">2</span><span class="token operator">&gt;</span> 点击确认按钮后 使用的是表单的提交!form标签没写method<span class="token punctuation">,</span>代表提交到当前url地址!
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><hr> <h2 id="用户管理"><a href="#用户管理" class="header-anchor">#</a> 用户管理</h2> <blockquote><p>UserInfo表的roles外键字段在 后续的分配权限处 进行处理!!</p></blockquote> <p>用户管理的CURD相对于角色管理的CURD, 复杂那么一丢丢. 涉及到了以下知识点!!<br> <font color="brown">额外字段、定义插件的两种方式、重写<code>__init__</code>方法、modelForm的继承、勾子函数、readonly+initial 、中文的错误提示设置.</font></p> <p><strong>先来看效果图.Hhh</strong></p> <p><img src="/assets/img/38.b8cb7562.gif" alt="38"></p> <p>用户新增页面 &gt; UserModelForm.<br>
用户编辑页面 &gt; UpdateUserModelForm.<br>
密码重置页面 &gt; ResetPasswordUserModelForm.</p> <p>■ 用户列表页面 - <font color="gray">与角色管理中角色列表差不多</font></p> <p><img src="/assets/img/image-20240310163033573.2b86ba70.png" alt="image-20240310163033573"></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>◎ UserInfo表字段 name、password、email、roles
<span class="token operator">-</span> 在视图函数里返回前端模版的是 用户对象<span class="token punctuation">,</span>该用户对象虽包含了该用户的所有的信息<span class="token operator">&lt;</span>eg<span class="token punctuation">:</span>包括用户密码<span class="token operator">&gt;</span>
  但最终渲染到模版中的信息有哪些<span class="token punctuation">,</span>模版中是可以把控的!! <span class="token operator">-</span><span class="token operator">-</span> 展示字段 用户名、邮箱
<span class="token operator">-</span> 模版中可通过a标签跳转其他功能 新增用户、重置密码、操作<span class="token operator">&lt;</span>编辑<span class="token operator">/</span>删除<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>■ 用户新增页面+重置密码页面. <font color="brown">readonly+initial</font></p> <p><img src="/assets/img/image-20240310205003724.f41cc921.png" alt="image-20240310205003724"></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>◎ UserInfo表字段 name、password、email、roles
<span class="token operator">-</span> 用户新增页面 <span class="token operator">&gt;</span> UserModelForm
  <span class="token operator">-</span> 展示字段 name、email、password <span class="token operator">+</span> 额外字段confirm_password
    需在勾子函数中验证 新增用户的密码和确认密码是否一致
  <span class="token operator">-</span> 定制插件的方式 保证了 在页面中输入密码和确认密码时 输入密码时是隐式的<span class="token punctuation">.</span>
<span class="token operator">-</span> 密码重置页面 <span class="token operator">&gt;</span> ResetPasswordUserModelForm
  <span class="token operator">-</span> 展示字段 name、password <span class="token operator">+</span> 额外字段confirm_password
    需在勾子函数中验证 新增用户的密码和确认密码是否一致
  <span class="token operator">-</span> 在重置密码的页面<span class="token punctuation">,</span> 用户名字段是不能编辑的<span class="token punctuation">.</span> <span class="token operator">-</span> 用 readonly 和 initial 来实现的!! ★★★
  <span class="token operator">-</span> 定制插件的方式 保证了 在页面中输入密码和确认密码时 是以小黑点的样子隐藏了<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>■ 用户编辑页面</p> <p><img src="/assets/img/image-20240310205316594.574744c7.png" alt="image-20240310205316594"></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>▲ 用户编辑页面 <span class="token operator">&gt;</span> UpdateUserModelForm
  <span class="token operator">-</span> 展示字段 name、email
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>■ 删除用户功能 与 角色管理中的删除一致</p> <p>■ 关于错误提示信息的中文显示,两种方式</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token number">1</span>）每个字段用插件自定义 error_messages<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;required&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;用户名不能为空!&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token number">2</span>）一劳永逸 在settings<span class="token punctuation">.</span>py配置文件中 
   LANGUAGE_CODE <span class="token operator">=</span> <span class="token string">'en-us'</span> 改为 LANGUAGE_CODE <span class="token operator">=</span> <span class="token string">'zh-hans'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><hr> <h2 id="菜单和权限管理"><a href="#菜单和权限管理" class="header-anchor">#</a> 菜单和权限管理</h2> <blockquote><p><font color="brown">(´･Д･)」三级联动、保留URL中的原搜索条件、ModelFrom中定制radio、ModelFrom 在save之前对其instance进行修改</font></p></blockquote> <h3 id="三级联动"><a href="#三级联动" class="header-anchor">#</a> 三级联动</h3> <blockquote><p>用一个路由/一个视图函数 实现一级菜单列表+二级菜单列表+非菜单权限列表 属实是三级联动了Hhh</p></blockquote> <p><font size="2" color="brown">一级菜单&lt;处理的是Menu表&gt; -- 二级菜单&lt;处理的Premission表中能当菜单的权限&gt;   -- 非菜单权限&lt;处理的Premission表中不能当菜单的权限&gt;.</font><br>
通过传递给模版first_menu_id、second_menu_id 实现选中的样式.以及新增按钮是否展示.<br>
通过 url的mid / first_menu_id获取到二级菜单的所有数据、通过url的sid / second_menu_id获取到非菜单权限的所有数据.</p> <p><img src="/assets/img/image-20240311161309874.d80362a0.png" alt="image-20240311161309874"></p> <p><font color="brown">敲黑板!! ?mid=2 后端接收到的是str类型  {row.id|safe} safe将row.id 整型变成了字符串  ★★★</font></p> <p>■ <code>http://127.0.0.1:8000/rbac/menu/list/</code><br>
当访问该网址的时候, 执行截图中<font color="green">&quot;绿色&quot;</font>标注的部分, 获得一级菜单的数据, 传递给模版, 在模版中进行渲染!!<br>
此时, 二三级的数据是没有的!! <font color="gray">(一级菜单没选的话,二级菜单是没有数据的,二级菜单面板上也不该有新增按钮)</font></p> <p>■ <code>http://127.0.0.1:8000/rbac/menu/list/?mid=1</code> --&gt; mid表明用户选择的一级菜单.<br>
当访问该网址的时候, 执行截图中<font color="red">&quot;红色&quot;</font>标注的部分!!<br>
简单来说, <code>&lt;a href=&quot;?mid={/{row.id}/}&quot;&gt;</code> 通过url的mid这个param实现了 <strong>一级二级的联动.</strong></p> <ul><li><strong>实现了一级菜单选中的样式</strong><br>
后端获取url参数,  <code>first_menu_id = request.GET.get(&quot;mid&quot;)</code> , 将该参数传递到模版中!!<br>
在模版中  <code>&lt;tr class=&quot;{% if row.id|safe == first_menu_id %}dc_menu_active{% endif %}&quot;&gt;</code></li> <li><strong>获取了二级菜单的数据.</strong><br>
这里很有意思! 我们不能直接通过 <code>models.Permission.objects.filter(menu__id=first_menu_id)</code> 来获取!!<br>
因为URL中没有mid参数的话, <code>request.GET.get(&quot;mid&quot;)</code> 的结果是None.<br>
根据Premission表的结构, 可知: <code>models.Permission.objects.filter(menu__id=None)</code> 得到的是 所有非菜单权限!!<br>
这不是我们想要的, 所以进行截图中那样的判断!</li> <li>first_menu_id 这个变量在模版中还有一个妙用!! <strong>一级菜单没选择,二级菜单的面板上不应该有&quot;新增&quot;的按钮!!</strong><br> <font color="blue">Q: 需要考虑的是, 用户可以通过手动给url添加mid参数来使二级面板上出现新增按钮, 如何解决呢? </font><br>
只需把截图的视图函数中注释的部分打开! 简单说就是在db中看存在不存在!!<font color="gray">(之所以注释掉了,是因为每次都要查一下, 消耗性能</font></li></ul> <p>■ <code>http://127.0.0.1:8000/rbac/menu/list/?mid=1&amp;sid=1</code> --&gt; mid表明用户选择的一级菜单.sid表明用户选择的二级菜单!!<br> <font color="blue">二级三级的联动同理, 通过sid实现了二级菜单的选中样式+获取了三级面板的数据+三级面板&quot;新增&quot;按钮是否展示!!</font><br>
具体的就不再赘述!! 但特别提醒的是:  <code>&lt;a href=&quot;?mid={/{first_menu_id}/}&amp;sid={/{row.id}/}&quot;&gt;</code></p> <p>三级联动,模版中其他需要注意的地方.</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>◆ 二级可作菜单的权限面板中
<span class="token operator">-</span> 为了避免 url 太长 导致二级菜单的表格的样式出现问题 合并单元格
  将CODE列和URL列放到了同一列 Hhhh <span class="token operator">-</span><span class="token operator">-</span> rowspan<span class="token operator">=</span><span class="token string">&quot;2&quot;</span>占两行<span class="token punctuation">;</span>colspan<span class="token operator">=</span><span class="token string">&quot;2&quot;</span>占两列<span class="token punctuation">;</span>style<span class="token operator">=</span><span class="token string">&quot;border-bottom: 0&quot;</span>
<span class="token operator">-</span> 二级菜单选中的样式
  <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">&quot;?mid={{ choice_menu_id }}&amp;sid={{ row.id }}&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> row<span class="token punctuation">.</span>title <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
  同样的套路<span class="token punctuation">,</span>后端接收到url的sid这个param<span class="token punctuation">,</span>再传给前端模版<span class="token punctuation">,</span>模版中进行比对<span class="token punctuation">,</span>对的上则加上选中样式
  <span class="token operator">&lt;</span>tr <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;{% if row.id|safe == second_menu_id %}dc_menu_active{% endif %}&quot;</span><span class="token operator">&gt;</span> 两个tr都要判断哦!

◆ 非菜单权限就不需要默认选中啦<span class="token punctuation">,</span>展示即可
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="保留url原搜索条件"><a href="#保留url原搜索条件" class="header-anchor">#</a> 保留URL原搜索条件</h3> <blockquote><p>就该示例而言: 当我们完成一些功能(eg:新增、编辑、删除)后, 返回原来的菜单列表页面, 页面上的菜单选中的样式依旧存在!!</p></blockquote> <p><font color="brown">★★★ 换个说法,点击新增、删除、编辑按钮生成的url,携带当前url中的参数</font><br> <font color="gray">这还是蛮重要的细节&lt;保留原搜索条件的功能 Django Admin的源码就是这么实现的&gt; (它也可以应用到角色和用户管理里面!!)</font></p> <p><img src="/assets/img/image-20240311190537649.f8da6a60.png" alt="image-20240311190537649"></p> <p>Q: 新生成的url中产生的url参数可能与原搜索条件的url参数可能会产生冲突/混乱.<br>
A: 解决方案: <strong>QueryDict</strong> - &amp;被转义了 等于&quot;=&quot;符号也被转义</p> <p><img src="/assets/img/39.e815ba23.gif" alt="39"></p> <p>当前url地址 <code>http://127.0.0.1:8000/rbac/menu/list/?mid=9&amp;sid=25</code> mid、sid选中了一级二级菜单.<br>
首先要知道当前访问的url地址对应的Django模版中, 还有修改、删除等按钮..<br>
就删除一级菜单的按钮而言, 此时已经自动渲染成了 <code>href=&quot;/rbac/menu/del/9/?_filter=mid%3D9%26sid%3D25&quot;</code><br>
当我们点击一级菜单的删除按钮后, 在对应的视图函数里, 取出 删除url中的参数 拼接到要删除后需跳转的地址上!!</p> <h3 id="modelfrom定制radio"><a href="#modelfrom定制radio" class="header-anchor">#</a> ModelFrom定制radio</h3> <blockquote><p>在ModelForm中定制 radio输入框 实现图标列表!! Ahh</p></blockquote> <p><img src="/assets/img/image-20240311192547467.70995d2a.png" alt="image-20240311192547467"></p> <p>Ps: 在前面我们设计一级菜单表的时候, 该表中的menu图标字段是可为空的, 现在应该改为不为空!!<br> <font color="blue">make_safe 表明不是以html代码显示, html渲染后显示,它是安全的</font></p> <h3 id="modelfrom显示默认值"><a href="#modelfrom显示默认值" class="header-anchor">#</a> ModelFrom显示默认值</h3> <blockquote><p>通过 first_menu_id 和 initial 来实现</p></blockquote> <p>一级、二级、三级面板的数据列表展示在 &quot;三级联动&quot; 那已经实现啦!<br>
一级菜单的CUD, 该说的 定制radio、保留URL原搜索条件(这个可复用) 都已经阐述了, 其余的不再赘述. 自己看代码都看得懂.<br>
下面我们先来瞅瞅二级菜单的CUD, 值得关注的地方就是.<br>
1&gt; 新增二级菜单的时候 ModelFrom显示默认值!! 需传代表 用户选择的一级菜单的参数 first_menu_id!!<br> <font color="gray">2&gt; 修改和删除跟前面的CURD的模版中一样,只需要传当前二级菜单表格中某一条数据的pk就行,Hhh</font></p> <p><img src="/assets/img/image-20240312140246017.93a7abca.png" alt="image-20240312140246017"></p> <p>Ps: <code>self.fields['menu'].empty_label = &quot;请选择一级菜单&quot;</code> 会将 <code>&quot;------&quot;变成了&quot;请选择一级菜单&quot;</code></p> <p><font color="brown">★ 思考一个问题!!</font></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>♀ 思考下<span class="token punctuation">:</span>
  假比 一级菜单我们选择的是 权限管理<span class="token punctuation">,</span> 其ID值是<span class="token number">9</span>!!
  模版中href<span class="token operator">=</span><span class="token string">&quot;{% memory_url request 'rbac:menu_second_add' first_menu_id=first_menu_id %}&quot;</span>经过渲染后的地址是
  http<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>rbac<span class="token operator">/</span>menu<span class="token operator">/</span>second<span class="token operator">/</span>add<span class="token operator">/</span><span class="token number">9</span><span class="token operator">/</span>?_filter<span class="token operator">=</span>mid<span class="token operator">%</span>3D9
  So<span class="token punctuation">,</span>点击二级面板中的新增<span class="token punctuation">,</span>跳转的是该地址!!
  「知道为啥渲染后是这个地址吗?因为 
   path<span class="token punctuation">(</span><span class="token string">'second/add/&lt;int:first_menu_id&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>menu_second_add<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'menu_second_add'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>」
  
  该地址会在浏览器的URL栏显示<span class="token punctuation">,</span>用户可以人为的修改 url地址中的 数字<span class="token number">9</span> <span class="token operator">&lt;</span>该数字代表用户选择的一级菜单<span class="token operator">&gt;</span>
  假比将 <span class="token number">9</span>改为了 <span class="token number">900</span><span class="token punctuation">,</span> ID为<span class="token number">900</span>的一级菜单是不存在的!! 
  代入代码中 initial<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'menu'</span><span class="token punctuation">:</span>first_menu_obj<span class="token punctuation">}</span> 实验效果相当于失效了<span class="token punctuation">.</span> 页面上 显示的是 <span class="token string">&quot;---------&quot;</span><span class="token punctuation">,</span>当然用户可在页面上自己选<span class="token punctuation">.</span>
  
  综上<span class="token punctuation">,</span>我们不用做任何额外的处理!!<span class="token punctuation">(</span>eg<span class="token punctuation">:</span>在initial之前判断first_menu_id是否存在 是不用做的!!<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>补充!!</strong> <font color="brown">严谨点,在二级菜单新增时,menu字段不应该为空,Hhh</font></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>在Permission表中 menu字段是可以为空的 <span class="token punctuation">,</span> 因为要兼顾非菜单权限<span class="token punctuation">,</span>非菜单权限时pid有值<span class="token punctuation">,</span>menu没值
但在二级面板中 针对可做菜单权限的增加<span class="token punctuation">.</span> 因为是可做菜单的权限<span class="token punctuation">,</span>所以menu应该有值<span class="token punctuation">,</span>pid没值!!
综上<span class="token punctuation">,</span>严谨点<span class="token punctuation">,</span>用户选择 <span class="token string">&quot;---------&quot;</span> 后端校验应该通过不了!! 怎么做呢?需要改一下ModelForm!!

<span class="token keyword">class</span> <span class="token class-name">BasicModelForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>ModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>BasicModelForm<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">for</span> name<span class="token punctuation">,</span> field <span class="token keyword">in</span> self<span class="token punctuation">.</span>fields<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            field<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span><span class="token string">'class'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'layui-input'</span>
            field<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span><span class="token string">'autocomplete'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;off&quot;</span>
        self<span class="token punctuation">.</span>fields<span class="token punctuation">[</span><span class="token string">'menu'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>empty_label <span class="token operator">=</span> <span class="token string">&quot;请选择一级菜单&quot;</span>  <span class="token comment"># !!!（¯﹃¯）增加用户体验</span>
        self<span class="token punctuation">.</span>fields<span class="token punctuation">[</span><span class="token string">'menu'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>required <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># !!!（¯﹃¯）字段校验不能为空. 数据库中的该字段是可以为空的.相当于覆盖啦.</span>


<span class="token keyword">class</span> <span class="token class-name">SecondMenuModelForm</span><span class="token punctuation">(</span>BasicModelForm<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;添加修改二级菜单时使用的&quot;&quot;&quot;</span>
    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> models<span class="token punctuation">.</span>Permission
        exclude <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;pid&quot;</span><span class="token punctuation">]</span>
        
■ 再想多一点<span class="token punctuation">,</span>想让把这个菜单权限变成非菜单权限呢? 去批量处理的页面进行操作!!那里可以进行更新<span class="token punctuation">.</span>Hhh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="save前修改instance"><a href="#save前修改instance" class="header-anchor">#</a> save前修改instance</h3> <blockquote><p>实现 非菜单权限的新增, 有两个方案!! 此示例我们选择用方案二 在save前修改instance来实现!!</p></blockquote> <p>目前, 一级和二级面板中的CURD+三级面板中的R 我们都已经完成. 下面我们来瞅瞅 三级面板中的 CUD!!</p> <p><img src="/assets/img/image-20240312151447981.3155e064.png" alt="image-20240312151447981"></p> <p><font color="brown">★ 思考一个问题!!</font></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>针对二级面板中 可做菜单权限的增加! 我们想的是 二级菜单归属的一级菜单可能会经常改变<span class="token punctuation">,</span>所以可以让用户自己选!!
那么三级面板中 非菜单权限的增加<span class="token punctuation">.</span> 也这样吗? No!
我们发现 非菜单权限一般都是新增、修改、删除<span class="token punctuation">,</span>其归属的二级菜单一般不会改变!!
★ 所以 我们规定 新增的非菜单权限的归属必定是当前选中的二级菜单!!!!

非菜单权限的新增 如何实现呢?
◎ Permission表已有字段 title、url、menu、pid、name
首先要明确menu字段是用不到的!!因为其在db中可为空<span class="token punctuation">,</span>所以不使用该字段<span class="token punctuation">,</span>在save时会自动赋值Null
<span class="token operator">-</span> 方案一
  使用字段 title、url、pid、name 
  之所以 使用了pid 是想让当前新增的非菜单权限归属的二级菜单给用户进行展示!!
  <span class="token string">&quot;该pid需要像可做菜单权限的新增一样 这里是通过second_menu_id传递!!&quot;</span>
  path<span class="token punctuation">(</span><span class="token string">'permission/add/&lt;int:second_menu_id&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>permission_add<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'permission_add'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  但默认展示的该字段用户改不了<span class="token punctuation">,</span>但会表单提交到后端!! 技术要点<span class="token punctuation">:</span> readonly<span class="token operator">+</span>initial <span class="token string">&quot;(´･Д･)」参考-用户管理处的重置密码页面!!&quot;</span>
<span class="token operator">-</span> 方案二 <span class="token punctuation">(</span>该示例我们采用它!!<span class="token punctuation">)</span>
  使用字段 title、url、name
  path<span class="token punctuation">(</span><span class="token string">'permission/add/&lt;int:second_menu_id&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>permission_add<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'permission_add'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  后端获取到second_menu_id后<span class="token punctuation">,</span>就知道用户选择的二级菜单是哪个了!! 
  <span class="token punctuation">(</span>严谨性<span class="token punctuation">,</span>需要验证该值背后的对象是否存在!! <span class="token string">&quot;与可做菜单权限的新增的代码进行对比,就很容易知道怎么回事啦!&quot;</span><span class="token punctuation">)</span>
  接下来重点在于!
    在保存之前往instance里加点东西!! ★★★
    form<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>pid <span class="token operator">=</span> second_menu_obj
    form<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>Ps: 非菜单权限的编辑和删除类似!</p> <hr> <h2 id="formset的使用"><a href="#formset的使用" class="header-anchor">#</a> formset的使用</h2> <blockquote><p>■ formset是什么?<br>
Form组件或ModelForm组件用于做&quot;一个&quot;表单的验证, formset用于做&quot;多个&quot;表单的验证<br>
表格里每一行都是一个表单,多个行由formset组合在了一起,批量的进行了验证</p> <p>■ 应用场景: 批量操作</p></blockquote> <p>为啥不用modelformset_factory呢??? 我试着捣鼓了下.. 有些技术问题 Hhh不想捣鼓了.<br>
武sir也说, ModelFormSet在该rbac项目中不适合..（¯﹃¯）</p> <h3 id="formset的批量添加"><a href="#formset的批量添加" class="header-anchor">#</a> formset的批量添加</h3> <blockquote><p>(´･Д･)」实现批量添加/增加的功能,并且有了&quot;唯一&quot;的异常也能捕获的</p></blockquote> <p><strong>关键代码如下:</strong></p> <p><img src="/assets/img/image-20240312203738343.ae99d83c.png" alt="image-20240312203738343"></p> <p>因为截图中空白区域有限, 在这里补充两个细节!!</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>■ formset<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">-</span> 注意哦<span class="token punctuation">,</span>因为使用的是forms<span class="token punctuation">.</span>Form<span class="token punctuation">,</span>所以是根据我们在表单中自己定义的字段进行的验证哦!
<span class="token operator">-</span> <span class="token string">&quot;Don't ask why?!&quot;</span> 实验结果就是这样的!! （¯﹃¯）想要知道为啥就去研究formset的源码<span class="token punctuation">,</span>Hhh
  <span class="token number">1.</span> 表格中的两行 都不填<span class="token punctuation">.</span>内部不会做验证<span class="token punctuation">,</span> 直接让你通过
     formset<span class="token punctuation">.</span>cleaned_data <span class="token operator">==</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token number">2.</span> 第一行数据哪怕写了一个<span class="token punctuation">,</span>都会对这一行数据进行表单验证<span class="token punctuation">;</span> 第二行啥都不写<span class="token punctuation">,</span>是不会对这一行数据进行表单验证的<span class="token punctuation">,</span>直接通过
     formset<span class="token punctuation">.</span>cleaned_data <span class="token operator">==</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">'title'</span><span class="token punctuation">:</span> <span class="token string">'11'</span><span class="token punctuation">,</span> <span class="token string">'url'</span><span class="token punctuation">:</span> <span class="token string">'111'</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'111'</span><span class="token punctuation">,</span> <span class="token string">'menu_id'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'pid_id'</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span>

■ post_row_list <span class="token operator">=</span> formset<span class="token punctuation">.</span>cleaned_data
  要注意一个细节<span class="token punctuation">,</span>当formset里没有错误信息的时<span class="token punctuation">,</span>执行formset<span class="token punctuation">.</span>cleaned_data才不会报错
  若检查formset中没有错误信息<span class="token punctuation">,</span>才能将用户提交的数据获取到!! 每次执行formset<span class="token punctuation">.</span>cleaned_data该语句<span class="token punctuation">,</span>都会检查
  因为后续可能会人为的往formset添加错误 So<span class="token punctuation">,</span>进行了一个赋值!!
  
  
<span class="token string">'\(≧▽≦)/'</span> formset_class <span class="token operator">=</span> formset_factory<span class="token punctuation">(</span>MultiPermissionForm<span class="token punctuation">,</span> extra<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> 
Q<span class="token punctuation">:</span> 在添加的时候<span class="token operator">/</span>更新的时候<span class="token punctuation">,</span>默认的显示几行初始数据<span class="token punctuation">,</span>如何实现?<span class="token operator">/</span>若extra<span class="token operator">=</span><span class="token number">0</span>的话<span class="token punctuation">,</span>不会额外生成<span class="token punctuation">,</span>那么个数如何指定呢? 
A<span class="token punctuation">:</span> formset_class<span class="token punctuation">(</span><span class="token punctuation">)</span>实例化时使用initial参数!传入<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>像这样就会对应两条数据 暂略<span class="token punctuation">.</span>
   <span class="token operator">&lt;</span>在后面权限的批量添加一级批量更新代码中<span class="token punctuation">,</span>发送GET请求时<span class="token punctuation">,</span>就是这样弄的!Hhh<span class="token operator">&gt;</span>
<span class="token punctuation">(</span>´･Д･<span class="token punctuation">)</span>」 Ps<span class="token punctuation">:</span>你对比下角色管理那CURD的模版<span class="token punctuation">,</span>会有不一样的feel哦!!
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="formset的批量更新"><a href="#formset的批量更新" class="header-anchor">#</a> formset的批量更新</h3> <blockquote><p>(´･Д･)」实现批量更新, 相比于添加, Form中多了一个ID字段, 因为需根据这个ID字段进行更新!!</p></blockquote> <p><strong>关键代码如下:</strong></p> <p><img src="/assets/img/image-20240312205717494.917d4667.png" alt="image-20240312205717494"></p> <hr> <h2 id="自动发现项目中url"><a href="#自动发现项目中url" class="header-anchor">#</a> 自动发现项目中URL</h2> <blockquote><p>给你一个项目, 请帮我获取当前项目中都有哪些URL以及name!!<br>
注意哦, name是用于反向生成url,所以有namespace的话,需要进行namespace的拼接!</p></blockquote> <p>在任何一个视图函数中执行 下面的get_all_url_dict方法就可获取项目中的所有路由!!<br>
构建的数据结构: <code>eg: {&quot;rbac:menu_list&quot;:{&quot;name&quot;:&quot;rbac:menu_list&quot;,&quot;url&quot;:&quot;/rbac/menu/list/&quot;},...,...}</code></p> <p><font color="gray">代码中的批注已经很清晰啦, 不再过多阐述.ψ(｀∇´)ψ</font></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> collections <span class="token keyword">import</span> OrderedDict  <span class="token comment"># 有序字典</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings
<span class="token keyword">from</span> django<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>module_loading <span class="token keyword">import</span> import_string  <span class="token comment"># 根据字符串的形式导入该模块</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls<span class="token punctuation">.</span>resolvers <span class="token keyword">import</span> URLResolver<span class="token punctuation">,</span> URLPattern
<span class="token keyword">import</span> re


<span class="token keyword">def</span> <span class="token function">check_url_exclude</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;自定制 排除一些特定的URL&quot;&quot;&quot;</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    AUTO_DISCOVER_EXCLUDE = [
        '/admin/.*',
        '/rbac/login/',
    ]
    &quot;&quot;&quot;</span>
    <span class="token keyword">for</span> regex <span class="token keyword">in</span> settings<span class="token punctuation">.</span>AUTO_DISCOVER_EXCLUDE<span class="token punctuation">:</span>
        <span class="token keyword">if</span> re<span class="token punctuation">.</span><span class="token keyword">match</span><span class="token punctuation">(</span>regex<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>


<span class="token keyword">def</span> <span class="token function">recursion_url</span><span class="token punctuation">(</span>pre_namespace<span class="token punctuation">,</span> pre_url<span class="token punctuation">,</span> urlpatterns<span class="token punctuation">,</span> url_ordered_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    用于递归的获取URL
    :param pre_namespace: namespace前缀,以后用于拼接name
    :param pre_url: url前缀,以后用于拼接url
    :param urlpatterns: 路由关系列表
    :param url_ordered_dict: 用于保存递归中获取的所有路由
    :return:
    &quot;&quot;&quot;</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> urlpatterns<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot; eg: 根路由下的urlpatterns循环出来的item
        &lt;URLResolver &lt;URLPattern list&gt; (admin:admin) 'admin/'&gt;
        &lt;URLResolver &lt;module 'apps.rbac.urls' from '/Desktop/dc_crm/apps/rbac/urls.py'&gt; (rbac:rbac) 'rbac/'&gt;
        &lt;URLResolver &lt;module 'apps.web.urls' from '/Desktop/dc_crm/apps/web/urls.py'&gt; (None:None) 'web/'&gt;
        &lt;URLPattern 'xxx/'&gt;
        - Django1.x中是RegexURLResolver、RegexURLPattern 
          -- from django.urls import RegexURLResolver, RegexURLPattern
        - Django2.x开始是URLResolver、URLPattern 
          -- from django.urls.resolvers import URLResolver, URLPattern
        &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> URLResolver<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 证明是路由分发,那么需要进行递归操作!!</span>
            <span class="token comment"># ■ 该语句体里表明,是进行路由分发的路由,该路由肯定不具备name值的,所以只能先对namespace进行处理!!</span>
            <span class="token comment"># [前面n级路由分发拼接的namespace] [当前的路由分发的namespace] 有 无 -- 排列组合,一共四种情况 Hhh</span>
            <span class="token comment"># 情况1: 当前路由分发有namespace和前面的n级路由分发经过迭代后拼接的namespace 都有,再次进行拼接</span>
            <span class="token keyword">if</span> pre_namespace <span class="token keyword">and</span> item<span class="token punctuation">.</span>namespace<span class="token punctuation">:</span>  
                namespace <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>pre_namespace<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span>item<span class="token punctuation">.</span>namespace<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
            <span class="token comment"># 情况2: 前面的n级路由分发都没有namespace,当前路由分发有</span>
            <span class="token keyword">elif</span> <span class="token keyword">not</span> pre_namespace <span class="token keyword">and</span> item<span class="token punctuation">.</span>namespace<span class="token punctuation">:</span> 
                namespace <span class="token operator">=</span> item<span class="token punctuation">.</span>namespace
            <span class="token comment"># 情况3: 前面的n级路由分发经过迭代后拼接的namespace 有, 当前路由分发没有</span>
            <span class="token keyword">elif</span> pre_namespace <span class="token keyword">and</span> <span class="token keyword">not</span> item<span class="token punctuation">.</span>namespace<span class="token punctuation">:</span>  
                namespace <span class="token operator">=</span> pre_namespace
            <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 情况4: 所有的路由分发都没有namespace</span>
                namespace <span class="token operator">=</span> <span class="token boolean">None</span>
            <span class="token triple-quoted-string string">&quot;&quot;&quot;
            - Django1.x中这么写
              recursion_urls(namespace, pre_url + item.regex.pattern, item.url_patterns, url_ordered_dict)
            - Django2以上不支持 item.regex
              item.regex.pattern 应改为 item.pattern.regex.pattern
            &quot;&quot;&quot;</span>
            <span class="token comment"># ■ url需要拼接当前路由的url前缀!! Ps: 你无需担心path中的&lt;str:pk&gt;之类的写法,它内部会自动转换为正则的样式!!</span>
            url <span class="token operator">=</span> pre_url <span class="token operator">+</span> item<span class="token punctuation">.</span>pattern<span class="token punctuation">.</span>regex<span class="token punctuation">.</span>pattern
            recursion_url<span class="token punctuation">(</span>namespace<span class="token punctuation">,</span> url<span class="token punctuation">,</span> item<span class="token punctuation">.</span>url_patterns<span class="token punctuation">,</span> url_ordered_dict<span class="token punctuation">)</span>  <span class="token comment"># &lt;★开始递归&gt;</span>
        <span class="token comment"># &lt;★★★其实它就是递归结束的条件,尽管执行它时,return的是None 也证明开始了回溯的过程!!&gt;</span>
        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> URLPattern<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 证明是非路由分发,那么需将路由添加到url_ordered_dict字典中!</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> item<span class="token punctuation">.</span>name<span class="token punctuation">:</span>  <span class="token comment"># 该url没有name,那么就不管</span>
                <span class="token keyword">continue</span>
            <span class="token comment"># 若该url的上一级进行了路由分发,分发时设置了namespace,那么需要将namespace与当前name进行拼接!</span>
            <span class="token keyword">if</span> pre_namespace<span class="token punctuation">:</span> 
                name <span class="token operator">=</span> <span class="token string">&quot;%s:%s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>pre_namespace<span class="token punctuation">,</span> item<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                name <span class="token operator">=</span> item<span class="token punctuation">.</span>name
            <span class="token comment"># 同理,若该url的上一级进行了路由分发,分发时设置了url前缀,那么需要进行拼接! 前缀 + 当前url</span>
            <span class="token comment"># 仔细想一想,其实每个上一级都有url前缀,哪怕是根路由,我们也手动传入了 &quot;/&quot; 前缀</span>
            <span class="token comment"># item.pattern.regex.pattern 可取到当前路由的url, Don't ask me why, 武sir在源码中看到的!</span>
            url <span class="token operator">=</span> pre_url <span class="token operator">+</span> item<span class="token punctuation">.</span>pattern<span class="token punctuation">.</span>regex<span class="token punctuation">.</span>pattern
            <span class="token comment"># eg: /^rbac/^user/edit/(?P&lt;pk&gt;\d+)/$ --&gt; /rbac/user/edit/(?P&lt;pk&gt;\d+)/</span>
            url <span class="token operator">=</span> url<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'^'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'$'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
            <span class="token comment"># □ 排除的自定制!! 比如排除,admin为前缀的url、login登陆</span>
            <span class="token keyword">if</span> check_url_exclude<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            url_ordered_dict<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span> <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span> url<span class="token punctuation">}</span>


<span class="token keyword">def</span> <span class="token function">get_all_url_dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;获取项目中所有的&lt;有name&gt;的URL (约定前提:URL必须得有name别名该URL才能被自动发现!!)&quot;&quot;&quot;</span>
    <span class="token comment"># eg: {&quot;rbac:menu_list&quot;:{&quot;name&quot;:&quot;rbac:menu_list&quot;,&quot;url&quot;:&quot;/rbac/menu/list/&quot;},...,...}</span>
    <span class="token comment"># 为啥要这么构建数据结构?</span>
    <span class="token comment"># 1.name值我们在数据库里设置了unique=True,具备唯一性,所有name值可以作为key</span>
    <span class="token comment"># 2.name还可以做粒度控制到按钮的权限判断</span>
    <span class="token comment"># So,我们约定俗成,项目中的url必须设置name,不然不会自动找到它!!</span>
    url_ordered_dict <span class="token operator">=</span> OrderedDict<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># settings.ROOT_URLCONF 表明根路由的路径,我们需根据字符串的形式导入该模块</span>
    md <span class="token operator">=</span> import_string<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>ROOT_URLCONF<span class="token punctuation">)</span>  <span class="token comment"># 'dc_crm.urls' --&gt; from dc_crm import urls</span>
    <span class="token comment"># [item for item in md.urlpatterns] # item ==&gt; RegexURLResolver/URLResolver   RegexURLPattern/URLPattern</span>
    <span class="token comment"># 调用它帮助我们递归的去获取所有路由 注:</span>
    <span class="token comment"># 1. 根路由是没有上一级的,也就不存在分发,所以一开始pre_namespace值为None</span>
    <span class="token comment"># 2. 给根路由的url前面都加上&quot;/&quot;,所以一开始pre_url值为&quot;/&quot;</span>
    <span class="token comment"># 3. md.urlpatterns根路由的路由关系列表</span>
    recursion_url<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> md<span class="token punctuation">.</span>urlpatterns<span class="token punctuation">,</span> url_ordered_dict<span class="token punctuation">)</span>
    <span class="token keyword">return</span> url_ordered_dict
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br></div></div><hr> <h2 id="权限的批量操作"><a href="#权限的批量操作" class="header-anchor">#</a> 权限的批量操作</h2> <blockquote><p>在上面我们已经学会两个前置知识点: formset的使用 + 自动发现项目中的URL<br>
该小节 我们来完成权限的批量操作!!<br> <strong>基本思路:</strong><br>
     集合1 - 自动发现,获取项目中所有的URL -- name集合<br>
     集合2 - 获取数据库中已添加的所有的URL -- name集合<br>
     对比两个集合,整理出应该添加、删除、修改的权限有哪些?!<br>
     - 数据库URL &gt; 项目发现的URL, 删除权限.<br>
     - 数据库URL &lt; 项目发现的URL, 增加权限.<br>
     - 数据库URL &amp; 项目发现的URL, 更新权限.</p></blockquote> <p>我就直接粘贴代码啦, 注释写得很清楚了!! <font color="gray">(本来想截图的, 篇幅太长了, 截不好 ╮(￣▽￣&quot;&quot;)╭ 这样反而省事了</font></p> <p><img src="/assets/img/image-20240312212252421.6bd1084d.png" alt="image-20240312212252421"></p> <p>提醒几点:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>■ 批量操作的页面有三个面板<span class="token punctuation">,</span> 当第一个面板执行post请求<span class="token punctuation">,</span> 提交有错误时<span class="token punctuation">,</span> 会在第一个面板上显示错误<span class="token punctuation">.</span>
但一定要注意此时第二个第三个面板中的数据也是要有的!! 我做了以下两个努力<span class="token punctuation">:</span>
<span class="token operator">-</span> <span class="token number">1.</span> 我使用了Django的CBV的写法<span class="token punctuation">,</span>让代码看起来更加清晰
<span class="token operator">-</span> <span class="token number">2.</span> 我封装了一个方法get_mutil_data<span class="token punctuation">,</span> 获取需在页面上展示的数据<span class="token punctuation">,</span>GET、POST请求都要执行它!!
你听起来可能云里雾里的<span class="token punctuation">,</span>但相信我<span class="token punctuation">,</span>你看代码就很容易明白啦!!

■ Form组件中<span class="token punctuation">,</span>细品下这行代码  ★核心思想在于<span class="token punctuation">,</span>menu和pid不能同时为空但有且只有一个有值!!
<span class="token comment"># 获得应该归属的二级菜单!!</span>
self<span class="token punctuation">.</span>fields<span class="token punctuation">[</span><span class="token string">'pid_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>choices <span class="token operator">+=</span> models<span class="token punctuation">.</span>Permission<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>pid__isnull<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> \
<span class="token punctuation">.</span>exclude<span class="token punctuation">(</span> menu__isnull<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values_list<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">)</span>
<span class="token comment"># 其实还有种写法是等效的!! </span>
self<span class="token punctuation">.</span>fields<span class="token punctuation">[</span><span class="token string">'pid_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>choices <span class="token operator">+=</span> models<span class="token punctuation">.</span>Permission<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>menu__isnull<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> \
<span class="token punctuation">.</span>exclude<span class="token punctuation">(</span>pid__isnull<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values_list<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">)</span>

■ 在批量添加的代码中<span class="token punctuation">,</span>细品下批量进行添加<span class="token punctuation">,</span>减轻数据库负担<span class="token punctuation">,</span>就不用每次连接数据库进行增加<span class="token punctuation">.</span>
  此处结合new_object<span class="token punctuation">.</span>validate_unique<span class="token punctuation">(</span><span class="token punctuation">)</span>的思考!!
  

■ 实现权限的批量增加<span class="token punctuation">,</span>权限批量更新<span class="token punctuation">,</span>一个个的删除
  新增<span class="token operator">/</span>更新
  <span class="token operator">-</span> <span class="token string">&quot;☆★★!!!&quot;</span>
    <span class="token operator">&lt;</span>button <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">&quot;submit&quot;</span><span class="token operator">&gt;</span>按钮 或者 <span class="token operator">&lt;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">&quot;submit&quot;</span><span class="token operator">&gt;</span>表单控件 都可以点击后通过form表单post请求进行提交
  <span class="token operator">-</span> 记得在前端form表单中写上 <span class="token punctuation">{</span><span class="token operator">%</span> csrf_token <span class="token operator">%</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> formset<span class="token punctuation">.</span>management_form <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token operator">-</span> <span class="token operator">&lt;</span>form method<span class="token operator">=</span><span class="token string">&quot;post&quot;</span> action<span class="token operator">=</span><span class="token string">&quot;?type=generate&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>form method<span class="token operator">=</span><span class="token string">&quot;post&quot;</span> action<span class="token operator">=</span><span class="token string">&quot;?type=update&quot;</span><span class="token operator">&gt;</span> 
    
■ 其它
<span class="token operator">-</span> Layui弹层layer中select没CSS样式或渲染失效的解决方法
  必须给表单体系所在的父元素加上 <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;layui-form&quot;</span>
<span class="token operator">-</span> Django中form组件的所有内置字段
  https<span class="token punctuation">:</span><span class="token operator">//</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>weixin_30835933<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">98952153</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>■ apps/rbac/views/menu/routers.py</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> views

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">'list/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>menu_list<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'menu_list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 一级菜单列表+二级菜单列表+非菜单权限列表</span>
    <span class="token comment"># 一级菜单的CUD</span>
    path<span class="token punctuation">(</span><span class="token string">'add/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>menu_add<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'menu_add'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'edit/&lt;int:pk&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>menu_edit<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'menu_edit'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'del/&lt;int:pk&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>menu_del<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'menu_del'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># 二级菜单的CUD</span>
    path<span class="token punctuation">(</span><span class="token string">'second/add/&lt;int:first_menu_id&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>menu_second_add<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'menu_second_add'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'second/edit/&lt;int:pk&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>menu_second_edit<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'menu_second_edit'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'second/del/&lt;int:pk&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>menu_second_del<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'menu_second_del'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># 非菜单权限的CUD</span>
    path<span class="token punctuation">(</span><span class="token string">'permission/add/&lt;int:second_menu_id&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>permission_add<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'permission_add'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'permission/edit/&lt;int:pk&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>permission_edit<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'permission_edit'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'permission/del/&lt;int:pk&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>permission_del<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'permission_del'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment"># 批量操作</span>
    <span class="token comment"># path('mutil/permissions/', views.multi_permissions, name='mutil_permissions'),</span>
    path<span class="token punctuation">(</span><span class="token string">'mutil/permissions/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>MultiPermissionsView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'multi_permissions'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'multi/permissions/del/&lt;int:pk&gt;/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>multi_permissions_del<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'multi_permissions_del'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>■ apps/rbac/views/menu/form.py</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">MultiAddPermissionForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>Form<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 特别注意哦!这里使用的是forms.Form</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;用于批量添加&quot;&quot;&quot;</span>
    title <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>
        widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">&quot;layui-input&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    url <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>
        widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">&quot;layui-input&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    name <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>
        widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">&quot;layui-input&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    menu_id <span class="token operator">=</span> forms<span class="token punctuation">.</span>ChoiceField<span class="token punctuation">(</span>
        choices<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'-----'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>Select<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">&quot;layui-input&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    pid_id <span class="token operator">=</span> forms<span class="token punctuation">.</span>ChoiceField<span class="token punctuation">(</span>
        choices<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'-----'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>Select<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">&quot;layui-input&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;style&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;width:10px&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">for</span> name<span class="token punctuation">,</span> field <span class="token keyword">in</span> self<span class="token punctuation">.</span>fields<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            field<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span><span class="token string">'autocomplete'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;off&quot;</span>
        self<span class="token punctuation">.</span>fields<span class="token punctuation">[</span><span class="token string">'menu_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>choices <span class="token operator">+=</span> models<span class="token punctuation">.</span>Menu<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>values_list<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">)</span>
        <span class="token comment"># 我们的默认是menu_id和pid_id一有值一无值,可能存在两个都无值,但不会存在两个都有值</span>
        <span class="token comment"># pid__isnull=True证明是二级菜单权限了,那么menu_id一定要有值 </span>
        <span class="token comment"># So,这里有排除了menu__isnull=True 保证不会出现两个都没值的情况 </span>
        <span class="token comment"># 两个都没值 - 应该是一开始添加的权限没进行分配的时候</span>
        self<span class="token punctuation">.</span>fields<span class="token punctuation">[</span><span class="token string">'pid_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>choices <span class="token operator">+=</span> models<span class="token punctuation">.</span>Permission<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>pid__isnull<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exclude<span class="token punctuation">(</span>
            menu__isnull<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values_list<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MultiEditPermissionForm</span><span class="token punctuation">(</span>forms<span class="token punctuation">.</span>Form<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;用于批量更新&quot;&quot;&quot;</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> forms<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>
        widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>HiddenInput<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    title <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>
        widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">&quot;layui-input&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    url <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>
        widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">&quot;layui-input&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    name <span class="token operator">=</span> forms<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>
        widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>TextInput<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">&quot;layui-input&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    menu_id <span class="token operator">=</span> forms<span class="token punctuation">.</span>ChoiceField<span class="token punctuation">(</span>
        choices<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'-----'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>Select<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">&quot;layui-input&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    pid_id <span class="token operator">=</span> forms<span class="token punctuation">.</span>ChoiceField<span class="token punctuation">(</span>
        choices<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'-----'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        widget<span class="token operator">=</span>forms<span class="token punctuation">.</span>Select<span class="token punctuation">(</span>attrs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'class'</span><span class="token punctuation">:</span> <span class="token string">&quot;layui-input&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">for</span> name<span class="token punctuation">,</span> field <span class="token keyword">in</span> self<span class="token punctuation">.</span>fields<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            field<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span><span class="token string">'autocomplete'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;off&quot;</span>
        self<span class="token punctuation">.</span>fields<span class="token punctuation">[</span><span class="token string">'menu_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>choices <span class="token operator">+=</span> models<span class="token punctuation">.</span>Menu<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>values_list<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fields<span class="token punctuation">[</span><span class="token string">'pid_id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>choices <span class="token operator">+=</span> models<span class="token punctuation">.</span>Permission<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>pid__isnull<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exclude<span class="token punctuation">(</span>
            menu__isnull<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values_list<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><p>■ apps/rbac/views/menu/views.py</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">MultiPermissionsView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>
    generate_formset <span class="token operator">=</span> <span class="token boolean">None</span>
    update_formset <span class="token operator">=</span> <span class="token boolean">None</span>
    delete_row_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">get_mutil_data</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;获取需在页面上展示的数据,GET、POST请求都要执行它!Hhh&quot;&quot;&quot;</span>
        <span class="token comment"># step1: 自动发现,获取项目中所有的URL -- name集合</span>
        <span class="token comment"># eg: {&quot;rbac:menu_list&quot;:{&quot;name&quot;:&quot;rbac:menu_list&quot;,&quot;url&quot;:&quot;/rbac/menu/list/&quot;},...,...}</span>
        all_url_dict <span class="token operator">=</span> get_all_url_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
        router_name_set <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>all_url_dict<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 获得路由对应的name 集合!</span>
        <span class="token comment"># step2: 获取数据库中已添加的所有的URL -- name集合</span>
        <span class="token comment"># permissions --&gt; queryset对象[{},{}..]</span>
        permissions <span class="token operator">=</span> models<span class="token punctuation">.</span>Permission<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;url&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;menu_id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pid_id&quot;</span><span class="token punctuation">)</span> 
        permission_dict <span class="token operator">=</span> OrderedDict<span class="token punctuation">(</span><span class="token punctuation">)</span>
        permission_name_set <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> row <span class="token keyword">in</span> permissions<span class="token punctuation">:</span>
            permission_dict<span class="token punctuation">[</span>row<span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> row
            permission_name_set<span class="token punctuation">.</span>add<span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># step3: 对比两个集合,整理出应该添加、删除、修改的权限有哪些?!</span>
        <span class="token comment"># 1&gt; 计算出应该增加的name -- 程序中有db中没有,相减得应该往db中添加的 So,循环的是all_url_dict</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>generate_formset<span class="token punctuation">:</span>  <span class="token comment"># ◆ 若是POST请求,这个if函数体的代码就不用执行</span>
            generate_name_set <span class="token operator">=</span> router_name_set <span class="token operator">-</span> permission_name_set
            generate_formset_class <span class="token operator">=</span> formset_factory<span class="token punctuation">(</span>MultiAddPermissionForm<span class="token punctuation">,</span> extra<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment"># formset批量增加</span>
            self<span class="token punctuation">.</span>generate_formset <span class="token operator">=</span> generate_formset_class<span class="token punctuation">(</span>initial<span class="token operator">=</span><span class="token punctuation">[</span>
                row_dict <span class="token keyword">for</span> name<span class="token punctuation">,</span> row_dict <span class="token keyword">in</span> all_url_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> name <span class="token keyword">in</span> generate_name_set
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 2&gt; 计算出应该更新的name -- db中有程序中也有,两者取完交集就是要更新的</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>update_formset<span class="token punctuation">:</span>  <span class="token comment"># ◆ 若是POST请求,这个if函数体的代码就不用执行</span>
            <span class="token comment"># Q:循环谁? A:循环permission_dict,因为db中还有menu_id,pid_id</span>
            <span class="token comment"># 思考:</span>
            <span class="token comment">#   需要更新的记录,name值肯定一样、url还需要判断是否一样</span>
            <span class="token comment">#   若不一样,应该以程序中的为准</span>
            <span class="token comment">#   &lt;这里我们让用户自行选择,因为程序中的可能因为手贱写错了,多打了一个字符&gt;,不然项目的某些功能会出问题.</span>
            <span class="token keyword">for</span> name<span class="token punctuation">,</span> value <span class="token keyword">in</span> permission_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                router_row_dict <span class="token operator">=</span> all_url_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
                <span class="token comment"># and第一个条件表明db中有程序中也有!! 若router_row_dict的bool值为False,表明db中有,程序中没有,这里直接不管</span>
                <span class="token comment"># if not router_row_dict:</span>
                <span class="token comment">#     continue</span>
                <span class="token keyword">if</span> router_row_dict <span class="token keyword">and</span> value<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> router_row_dict<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    <span class="token comment"># permission_dict中对应记录的url字段的值进行了修改,用于提示用户,这个赋值并没有同步数据库哈Hhh</span>
                    value<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'路由和数据库中不一致'</span>  
            update_name_list <span class="token operator">=</span> router_name_set <span class="token operator">&amp;</span> permission_name_set
            update_formset_class <span class="token operator">=</span> formset_factory<span class="token punctuation">(</span>MultiEditPermissionForm<span class="token punctuation">,</span> extra<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment"># formset批量更新 ☆必须要有个隐藏的ID</span>
            self<span class="token punctuation">.</span>update_formset <span class="token operator">=</span> update_formset_class<span class="token punctuation">(</span>initial<span class="token operator">=</span><span class="token punctuation">[</span>
                row_dict <span class="token keyword">for</span> name<span class="token punctuation">,</span> row_dict <span class="token keyword">in</span> permission_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> name <span class="token keyword">in</span> update_name_list
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 3&gt; 计算出应该删除的name -- db中有程序中没有,相减得应该在db中删除的 So,循环的是permission_dict</span>
        delete_name_set <span class="token operator">=</span> permission_name_set <span class="token operator">-</span> router_name_set
        <span class="token comment"># 不会批量删除,一股脑的批量删除不好,因为可能是百度合作的地址之类的!!</span>
        self<span class="token punctuation">.</span>delete_row_list <span class="token operator">=</span> \
            <span class="token punctuation">[</span>row_dict <span class="token keyword">for</span> name<span class="token punctuation">,</span> row_dict <span class="token keyword">in</span> permission_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> name <span class="token keyword">in</span> delete_name_set<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>get_mutil_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'rbac/menu/multi_permissions.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token string">'generate_formset'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>generate_formset<span class="token punctuation">,</span>  <span class="token comment"># formset批量增加 的数据</span>
            <span class="token string">'delete_row_list'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>delete_row_list<span class="token punctuation">,</span>  <span class="token comment"># 删除的数据列表 的数据</span>
            <span class="token string">'update_formset'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>update_formset<span class="token punctuation">,</span>  <span class="token comment"># formset批量更新 的数据 ☆必须要有个隐藏的ID</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        post_type <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">)</span>
        generate_formset_class <span class="token operator">=</span> formset_factory<span class="token punctuation">(</span>MultiAddPermissionForm<span class="token punctuation">,</span> extra<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        update_formset_class <span class="token operator">=</span> formset_factory<span class="token punctuation">(</span>MultiEditPermissionForm<span class="token punctuation">,</span> extra<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token comment"># 批量添加</span>
        <span class="token keyword">if</span> post_type <span class="token operator">==</span> <span class="token string">'generate'</span><span class="token punctuation">:</span>
            formset <span class="token operator">=</span> generate_formset_class<span class="token punctuation">(</span>data<span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
            <span class="token comment"># print(request.POST)</span>
            <span class="token keyword">if</span> formset<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                object_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                has_error <span class="token operator">=</span> <span class="token boolean">False</span>
                post_row_list <span class="token operator">=</span> formset<span class="token punctuation">.</span>cleaned_data  <span class="token comment"># 通过表单验证成功的数据,但还需手动进行唯一索引验证!!</span>
                <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> formset<span class="token punctuation">.</span>total_form_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    row_dict <span class="token operator">=</span> post_row_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span>row_dict<span class="token punctuation">)</span>
                    <span class="token keyword">try</span><span class="token punctuation">:</span>
                        new_object <span class="token operator">=</span> models<span class="token punctuation">.</span>Permission<span class="token punctuation">(</span><span class="token operator">**</span>row_dict<span class="token punctuation">)</span>
                        <span class="token triple-quoted-string string">&quot;&quot;&quot;
                        不得不提的是,validate_unique是先看ORM表中哪个字段(eg:name字段)有唯一索引,
                        然后去db数据库中跟已有数据进行比对!!
                        这里,我们的代码逻辑是连接一次数据库,添加多条数据,
                        所以 新增的那些行数据如果有name值相同的,该行代码是检查不出来的.
                        但回过头来想想,name值是程序员自己设定的,设定重复了,就是自己蠢.
                        再者,你回顾自动发现url的代码逻辑,name作为字段的key值,发现了重复的name,直接就覆盖了!!
                        So,此处模版中 待新增表格中的name字段必不可能重复. 
                        综合下来,只要不是人为的修改,添加到db中的name值也必不可能重复!!
                        &gt;&gt;&gt; my_dict = {}
                        &gt;&gt;&gt; my_dict[&quot;1&quot;] = 2
                        &gt;&gt;&gt; my_dict
                        {'1': 2}
                        &gt;&gt;&gt; my_dict[&quot;1&quot;] = 3
                        &gt;&gt;&gt; my_dict
                        {'1': 3}
                        &quot;&quot;&quot;</span>
                        new_object<span class="token punctuation">.</span>validate_unique<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 未抛出异常,则唯一索引验证通过</span>
                        object_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>new_object<span class="token punctuation">)</span>
                    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                        formset<span class="token punctuation">.</span>errors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>e<span class="token punctuation">)</span>  <span class="token comment"># 唯一索引的错误添加到formset中!!</span>
                        self<span class="token punctuation">.</span>generate_formset <span class="token operator">=</span> formset  <span class="token comment"># （¯﹃¯）</span>
                        has_error <span class="token operator">=</span> <span class="token boolean">True</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> has_error<span class="token punctuation">:</span>
                    <span class="token comment"># **批量进行添加,减轻数据库负担 就不用每次连接数据库进行增加 放心大胆的用!!</span>
                    models<span class="token punctuation">.</span>Permission<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>bulk_create<span class="token punctuation">(</span>object_list<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment"># is_valid()未验证通过</span>
                <span class="token comment"># 错误信息在formset里,赋值给了类实例对象的generate_formset,根据查找规则,会用它,而不会用类里的.</span>
                self<span class="token punctuation">.</span>generate_formset <span class="token operator">=</span> formset  <span class="token comment"># （¯﹃¯）</span>
        <span class="token comment"># 批量更新</span>
        <span class="token keyword">if</span> post_type <span class="token operator">==</span> <span class="token string">'update'</span><span class="token punctuation">:</span>
            formset <span class="token operator">=</span> update_formset_class<span class="token punctuation">(</span>data<span class="token operator">=</span>request<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
            <span class="token keyword">if</span> formset<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                post_row_list <span class="token operator">=</span> formset<span class="token punctuation">.</span>cleaned_data
                <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> formset<span class="token punctuation">.</span>total_form_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    row_dict <span class="token operator">=</span> post_row_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                    permission_id <span class="token operator">=</span> row_dict<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>  <span class="token comment"># 拿到那个隐藏的ID,你才知道更新哪个嘛!</span>
                    <span class="token keyword">try</span><span class="token punctuation">:</span>
                        row_object <span class="token operator">=</span> models<span class="token punctuation">.</span>Permission<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>permission_id<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> row_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                            <span class="token builtin">setattr</span><span class="token punctuation">(</span>row_object<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
                        row_object<span class="token punctuation">.</span>validate_unique<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        row_object<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 鬼知道为啥这里又一行行的save到db中.Hhh</span>
                    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                        formset<span class="token punctuation">.</span>errors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
                        self<span class="token punctuation">.</span>update_formset <span class="token operator">=</span> formset
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>update_formset <span class="token operator">=</span> formset

        self<span class="token punctuation">.</span>get_mutil_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'rbac/menu/multi_permissions.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token string">'generate_formset'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>generate_formset<span class="token punctuation">,</span>
            <span class="token string">'delete_row_list'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>delete_row_list<span class="token punctuation">,</span>
            <span class="token string">'update_formset'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>update_formset<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">multi_permissions_del</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> pk<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;批量页面的权限删除&quot;&quot;&quot;</span>
    url <span class="token operator">=</span> memory_reverse<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'rbac:multi_permissions'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'rbac/delete.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'cancel'</span><span class="token punctuation">:</span> url<span class="token punctuation">}</span><span class="token punctuation">)</span>

    models<span class="token punctuation">.</span>Permission<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>pk<span class="token punctuation">)</span><span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br></div></div><hr></div></div> <!----> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/1fb3a1/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">动态菜单</div></a> <a href="/pages/7an1m1/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">权限分配</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/1fb3a1/" class="prev">动态菜单</a></span> <span class="next"><a href="/pages/7an1m1/">权限分配</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/8sk2b3/"><div>
            搜索相关
            <!----></div></a> <span class="date">03-22</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/2kn2p2/"><div>
            CURD
            <!----></div></a> <span class="date">03-20</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/1kn1m1/"><div>
            自动生成
            <!----></div></a> <span class="date">03-15</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/OnePieceDC" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://www.cnblogs.com/DC0307/" title="博客园" target="_blank" class="iconfont icon-bokeyuan"></a><a href="https://music.163.com/#/song?id=1854188649" title="听音乐" target="_blank" class="iconfont icon-erji"></a><a href="https://www.jianshu.com/u/5310eb537315" title="简书" target="_blank" class="iconfont icon-jianshu"></a><a href="mailto:1415806497@qq.com" title="QQ" target="_blank" class="iconfont icon-youjian"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2024
    <span>DC | One Piece</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><!----><div id="goTop" class="hide-cat" data-v-8ccb5928></div><div></div><canvas id="vuepress-canvas-cursor"></canvas><div></div><div></div></div></div>
    <script src="/assets/js/app.ac54adc6.js" defer></script><script src="/assets/js/4.7ddc74e3.js" defer></script><script src="/assets/js/1.a0c4ff1b.js" defer></script><script src="/assets/js/3.8b03321d.js" defer></script><script src="/assets/js/18.46f9153d.js" defer></script><script src="/assets/js/104.cae2d944.js" defer></script><script src="/assets/js/184.46eabf07.js" defer></script>
  </body>
</html>
